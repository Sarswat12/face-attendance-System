name: Pull, retag and push image to GHCR
on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  retag-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Login to source registry (if needed)
        if: ${{ secrets.SOURCE_REGISTRY }}
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.SOURCE_REGISTRY }}
          username: ${{ secrets.SOURCE_REGISTRY_USERNAME }}
          password: ${{ secrets.SOURCE_REGISTRY_PASSWORD }}

      - name: Pull prebuilt image
        env:
          PREBUILT: ${{ secrets.PREBUILT_IMAGE }}
        run: docker pull "$PREBUILT"

      - name: Retag for GHCR
        run: |
          SRC="${{ secrets.PREBUILT_IMAGE }}"
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          docker tag "$SRC" "ghcr.io/${OWNER}/${REPO}:latest"

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Push to GHCR
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          docker push "ghcr.io/${OWNER}/${REPO}:latest"

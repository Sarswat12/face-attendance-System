name: Pull, retag and push image to GHCR
on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  retag-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Docker CLI
        uses: docker/setup-docker@v3

      - name: Login to source registry (if private)
        if: ${{ secrets.SOURCE_REGISTRY && secrets.SOURCE_REGISTRY != '' }}
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.SOURCE_REGISTRY }}
          username: ${{ secrets.SOURCE_REGISTRY_USERNAME }}
          password: ${{ secrets.SOURCE_REGISTRY_PASSWORD }}

      - name: Pull prebuilt image
        env:
          PREBUILT: ${{ secrets.PREBUILT_IMAGE }}
        run: |
          echo "Pulling $PREBUILT"
          docker pull "$PREBUILT"

      - name: Create GHCR target tag
        id: make_tag
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          TARGET="ghcr.io/${OWNER}/${REPO}:latest"
          echo "target=$TARGET" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Tag and push to GHCR
        run: |
          SRC="${{ secrets.PREBUILT_IMAGE }}"
          TARGET="${{ steps.make_tag.outputs.target }}"
          echo "Retagging $SRC -> $TARGET"
          docker tag "$SRC" "$TARGET"
          echo "Pushing $TARGET"
          docker push "$TARGET"

      - name: Verify
        run: |
          echo "Done. Pushed ${{ steps.make_tag.outputs.target }}"
